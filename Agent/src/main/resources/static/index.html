<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI角色扮演语音聊天</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f0f2f5;
            transition: background-color 0.3s ease;
        }
        
        /* 暗黑模式样式 - 全黑效果 */
        body.dark {
            background-color: #000000;
            color: #e0e0e0;
        }
        
        body.dark .bg-white {
            background-color: #000000;
            color: #e0e0e0;
        }
        
        body.dark .text-gray-800 {
            color: #e0e0e0;
        }
        
        body.dark .text-gray-600 {
            color: #b0b0b0;
        }
        
        body.dark .bg-gray-100 {
            background-color: #000000;
        }
        
        body.dark .border-gray-100 {
            border-color: #222222;
        }
        
        body.dark .border-gray-300 {
            border-color: #333333;
        }
        
        body.dark .hover:bg-gray-200 {
            background-color: #111111;
        }
        
        body.dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.8);
        }
        
        body.dark textarea {
            background-color: #111111;
            color: #e0e0e0;
            border-color: #333333;
        }
        
        body.dark textarea::placeholder {
            color: #808080;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* 输入框自适应高度 */
        textarea {
            min-height: 44px;
            max-height: 200px;
            transition: height 0.2s ease;
        }

        /* 加载动画 */
        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
        }

        .animate-pulse {
            animation: pulse 1.5s infinite;
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        /* 打字机效果 */
        .typing-cursor::after {
            content: "|";
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            from, to {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }
        
        /* 淡入效果 */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* 角色卡片悬停效果 */
        .role-card {
            transition: all 0.3s ease;
        }
        
        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* 按钮悬停效果 */
        .btn-hover {
            transition: all 0.2s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-1px);
        }
        
        /* 平滑过渡 */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* 加载状态 */
        .loading-dots > div {
            animation: loading 1.4s infinite ease-in-out both;
        }
        
        .loading-dots > div:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots > div:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loading {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
    </style>
</head>
<body v-bind:class="{ 'dark': darkMode }">
<div id="app" class="h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md z-10">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fas fa-robot text-blue-600 text-2xl"></i>
                <div class="text-xl font-bold text-gray-800">AI角色扮演</div>
            </div>
            <div class="flex items-center space-x-4">
                <button 
                    @click="showRoleSelection = !showRoleSelection"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg btn-hover flex items-center space-x-2"
                >
                    <i class="fas fa-mask"></i>
                    <span v-if="currentRole">切换角色</span>
                    <span v-else>选择角色</span>
                </button>
                <button 
                    @click="startNewConversation"
                    class="bg-green-500 text-white p-2 rounded-lg btn-hover"
                >
                    <i class="fas fa-plus"></i>
                </button>
                <button 
                    @click="toggleDarkMode"
                    class="p-2 rounded-full hover:bg-gray-100 smooth-transition"
                >
                    <i :class="darkMode ? 'fas fa-sun text-amber-500' : 'fas fa-moon text-gray-600'"></i>
                </button>
            </div>
        </div>
        
        <!-- 当前角色信息 -->
        <div v-if="currentRole && !showRoleSelection" class="bg-blue-50 py-2 px-4 border-t border-blue-100">
            <div class="container mx-auto flex items-center space-x-3">
                <img :src="currentRole.avatar" alt="角色头像" class="w-8 h-8 rounded-full object-cover">
                <div class="flex-1">
                    <div class="font-semibold text-gray-800">{{ currentRole.name }}</div>
                    <div class="text-xs text-gray-600 truncate max-w-md">{{ currentRole.description }}</div>
                </div>
                <div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                    {{ getRoleTypeLabel(currentRole.type) }}
                </div>
            </div>
        </div>
    </header>

    <!-- 角色选择模态框 -->
    <div v-if="showRoleSelection" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden">
            <!-- 模态框头部 -->
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">选择角色</h2>
                <button @click="showRoleSelection = false" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- 搜索栏 -->
            <div class="p-4 border-b">
                <div class="flex justify-between items-center mb-3">
                    <div class="relative flex-1 mr-3">
                        <input 
                            v-model="roleSearchKeyword"
                            @input="searchRoles"
                            type="text"
                            placeholder="搜索角色名称或技能..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button 
                        @click="showAddRoleForm = true"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 btn-hover"
                    >
                        <i class="fas fa-plus"></i>
                        <span>添加角色</span>
                    </button>
                </div>
                
                <!-- 角色类型筛选 -->
                <div class="mt-2 flex flex-wrap gap-2">
                    <button 
                        v-for="type in roleTypes"
                        :key="type.value"
                        @click="filterRolesByType(type.value)"
                        :class="['px-3 py-1 rounded-full text-sm', 
                            selectedType === type.value 
                                ? 'bg-blue-600 text-white'
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200']"
                    >
                        {{ type.label }}
                    </button>
                </div>
            </div>
            
            <!-- 添加角色表单模态框 -->
            <div v-if="showAddRoleForm" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">添加新角色</h2>
                        <button @click="showAddRoleForm = false; resetAddRoleForm()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <form @submit.prevent="handleAddRole">
                            <div class="space-y-4">
                                <!-- 角色名称 -->
                                <div>
                                    <label for="roleName" class="block text-sm font-medium text-gray-700 mb-1">角色名称 <span class="text-red-500">*</span></label>
                                    <input 
                                        id="roleName"
                                        v-model="newRole.name"
                                        type="text"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>
                                
                                <!-- 角色描述 -->
                                <div>
                                    <label for="roleDescription" class="block text-sm font-medium text-gray-700 mb-1">角色描述 <span class="text-red-500">*</span></label>
                                    <textarea 
                                        id="roleDescription"
                                        v-model="newRole.description"
                                        required
                                        rows="3"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    ></textarea>
                                </div>
                                
                                <!-- 角色提示词模板 -->
                                <div>
                                    <label for="rolePromptTemplate" class="block text-sm font-medium text-gray-700 mb-1">角色提示词模板 <span class="text-red-500">*</span></label>
                                    <textarea 
                                        id="rolePromptTemplate"
                                        v-model="newRole.promptTemplate"
                                        required
                                        rows="4"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    ></textarea>
                                    <p class="text-xs text-gray-500 mt-1">提示：提示词应包含角色身份、背景和回答风格的详细描述。</p>
                                </div>
                                
                                <!-- 角色类型 -->
                                <div>
                                    <label for="roleType" class="block text-sm font-medium text-gray-700 mb-1">角色类型 <span class="text-red-500">*</span></label>
                                    <select 
                                        id="roleType"
                                        v-model="newRole.type"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="">请选择角色类型</option>
                                        <option v-for="type in roleTypes" :key="type.value" :value="type.value">
                                            {{ type.label }}
                                        </option>
                                    </select>
                                </div>
                                
                                <!-- 角色技能描述 -->
                                <div>
                                    <label for="roleSkills" class="block text-sm font-medium text-gray-700 mb-1">角色技能描述 <span class="text-red-500">*</span></label>
                                    <input 
                                        id="roleSkills"
                                        v-model="newRole.skills"
                                        type="text"
                                        required
                                        placeholder="使用逗号分隔多个技能"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                </div>
                                
                                <!-- 角色头像 (不可修改) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">角色头像</label>
                                    <input 
                                        type="text"
                                        v-model="newRole.avatar"
                                        disabled
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500"
                                    >
                                    <p class="text-xs text-gray-500 mt-1">系统将自动生成角色头像，无法手动修改。</p>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end space-x-3">
                                <button 
                                    type="button"
                                    @click="showAddRoleForm = false; resetAddRoleForm()"
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                                >
                                    取消
                                </button>
                                <button 
                                    type="submit"
                                    :disabled="isAddingRole"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <span v-if="isAddingRole">添加中...</span>
                                    <span v-else>添加角色</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 角色列表 -->
            <div class="flex-1 overflow-y-auto p-4">
                <div v-if="isLoadingRoles" class="flex justify-center items-center h-64">
                    <div class="loading-dots flex space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    </div>
                </div>
                <div v-else-if="filteredRoles.length === 0" class="flex justify-center items-center h-64 text-gray-500">
                    没有找到匹配的角色
                </div>
                <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div 
                        v-for="role in filteredRoles"
                        :key="role.id"
                        @click="selectRole(role)"
                        class="role-card bg-white border border-gray-200 rounded-xl p-4 cursor-pointer"
                    >
                        <div class="flex items-start space-x-4">
                            <div class="w-14 h-14 rounded-full bg-blue-500 flex items-center justify-center text-white">
                                <i class="fas fa-robot text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-lg text-gray-800">{{ role.name }}</div>
                                <div class="text-sm text-gray-600 mt-1 line-clamp-2">{{ role.description }}</div>
                                <div class="mt-2 flex items-center text-xs">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">
                                        {{ getRoleTypeLabel(role.type) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="text-xs font-medium text-gray-500">技能:</div>
                            <div class="text-sm text-gray-700 mt-1">{{ role.skills }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧会话列表 (小屏幕隐藏) -->
        <div class="hidden lg:block w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b">
                <h3 class="font-semibold text-gray-800">对话历史</h3>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div 
                    v-for="conversation in conversations"
                    :key="conversation.id"
                    @click="switchConversation(conversation)"
                    :class="['p-4 border-b hover:bg-gray-50 cursor-pointer',
                            activeConversationId === conversation.id ? 'bg-blue-50' : '']"
                >
                    <div class="font-medium text-gray-800 truncate">{{ conversation.title }}</div>
                    <div class="text-xs text-gray-500 mt-1 truncate">{{ conversation.lastMessage }}</div>
                </div>
            </div>
        </div>
        
        <!-- 右侧聊天区域 -->
        <div class="flex-1 flex flex-col bg-gray-50">
            <!-- 聊天内容区域 -->
            <main class="flex-1 overflow-y-auto p-4 space-y-6" ref="chatContainer">
                <div v-if="messages.length === 0" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <i class="fas fa-comment-dots text-6xl mb-4"></i>
                    <p class="text-lg">还没有消息</p>
                    <p class="text-sm mt-2">选择一个角色开始对话吧</p>
                </div>
                
                <div v-for="(message, index) in messages" :key="index" class="max-w-3xl mx-auto">
                    <div :class="['flex', message.role === 'user' ? 'justify-end' : 'justify-start']">
                        <div :class="['flex items-start space-x-3', message.role === 'user' ? 'flex-row-reverse space-x-reverse' : '']">
                            <!-- 头像 -->
                            <div v-if="message.role === 'assistant' && currentRole" class="relative">
                                <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white border-2 border-white shadow-sm dark:border-gray-800">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div v-if="message.isStreaming" class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"></div>
                            </div>
                            <div v-else-if="message.role === 'assistant'" class="w-10 h-10 rounded-full flex items-center justify-center bg-green-100 text-green-600 dark:bg-gray-700 dark:text-green-400">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div v-else class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-100 text-blue-600 dark:bg-gray-700 dark:text-blue-400">
                                <i class="fas fa-user"></i>
                            </div>
                            
                            <!-- 消息内容 -->
                            <div :class="['p-3 rounded-lg max-w-lg',
                                            message.role === 'user'
                                                ? 'bg-blue-500 text-white'
                                                : 'bg-white shadow border border-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:text-white']">
                                <div v-if="message.role === 'assistant' && message.isLoading" class="flex space-x-2">
                                    <div class="w-2 h-2 rounded-full bg-gray-300 animate-pulse"></div>
                                    <div class="w-2 h-2 rounded-full bg-gray-300 animate-pulse delay-100"></div>
                                    <div class="w-2 h-2 rounded-full bg-gray-300 animate-pulse delay-200"></div>
                                </div>
                                <div v-else class="whitespace-pre-wrap">
                                        <span v-for="(char, charIndex) in message.content" :key="charIndex"
                                              :class="{'opacity-0': charIndex >= message.visibleChars, 'fade-in': charIndex < message.visibleChars}">
                                            {{ char }}
                                        </span>
                                    <span v-if="message.isStreaming" class="typing-cursor"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 输入框区域 -->
            <footer class="border-t p-4 bg-white">
                <div class="max-w-3xl mx-auto">
                    <div class="flex items-end space-x-3">
                        <!-- 语音输入按钮 -->
                        <div class="flex space-x-1">
                            <button 
                                @click="toggleVoiceInput"
                                :disabled="!hasSpeechRecognition || isLoading"
                                :class="['p-3 rounded-full btn-hover',
                                        isVoiceRecording
                                            ? 'bg-red-500 text-white'
                                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200',
                                        'disabled:opacity-50 disabled:cursor-not-allowed']"
                            >
                                <i :class="isVoiceRecording ? 'fas fa-microphone-slash' : 'fas fa-microphone'"></i>
                            </button>
                            
                            <!-- 语音播放按钮 (仅在AI消息时显示) -->
                            <button 
                                v-if="messages.length > 0 && messages[messages.length - 1].role === 'assistant' && !isLoading"
                                @click="playVoiceResponse"
                                :disabled="!hasSpeechSynthesis"
                                class="p-3 rounded-full btn-hover bg-gray-100 text-gray-600 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                        
                        <!-- 文本输入框 -->
                        <textarea
                                v-model="userInput"
                                @keydown.enter.exact.prevent="sendMessage"
                                @keydown.ctrl.enter.exact.prevent="sendMessage"
                                @keydown.esc.exact="stopResponse"
                                placeholder="输入您的问题..."
                                class="flex-1 border rounded-lg py-3 px-4 focus:outline-none focus:ring-2 border-gray-300 focus:ring-blue-500 focus:border-transparent resize-none"
                                rows="1"
                                ref="textarea"
                                @input="adjustTextareaHeight"
                                :disabled="isLoading"
                        ></textarea>
                        
                        <!-- 发送按钮 -->
                        <button
                                @click="isLoading ? stopResponse() : sendMessage()"
                                :disabled="!userInput.trim() && !isLoading"
                                :class="['p-3 rounded-lg btn-hover',
                                        isLoading
                                            ? 'bg-red-500 text-white'
                                            : 'bg-blue-500 hover:bg-blue-600 text-white',
                                        'disabled:opacity-50 disabled:cursor-not-allowed']"
                        >
                            <i :class="isLoading ? 'fas fa-stop' : 'fas fa-paper-plane'"></i>
                        </button>
                    </div>
                    
                    <!-- 语音识别状态提示 -->
                    <div v-if="isVoiceRecording" class="mt-2 text-sm text-red-500 flex items-center">
                        <i class="fas fa-microphone mr-2"></i>
                        <span>正在录音，请说话...</span>
                    </div>
                    <div v-else-if="voiceInputText" class="mt-2 text-sm text-blue-500 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>语音识别: {{ voiceInputText }}</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>
</div>

<script>
    const {createApp, ref, nextTick, onMounted, watch, computed} = Vue;

    createApp({
        setup() {
            // 核心状态管理
            const messages = ref([]);
            const userInput = ref('');
            const isLoading = ref(false);
            const chatContainer = ref(null);
            const textarea = ref(null);
            const darkMode = ref(false);
            const showRoleSelection = ref(false);
            const currentRole = ref(null);
            const roleSearchKeyword = ref('');
            const selectedType = ref('');
            const isLoadingRoles = ref(false);
            
            // 语音相关状态
            const isVoiceRecording = ref(false);
            const voiceInputText = ref('');
            const hasSpeechRecognition = ref('MediaRecorder' in window && navigator.mediaDevices);
            const hasSpeechSynthesis = ref('speechSynthesis' in window);
            let mediaRecorder = null;
            let audioChunks = [];
            let stream = null;
            
            // 会话管理
            const conversations = ref([]);
            const activeConversationId = ref(Date.now().toString());
            const memoeryId = ref(activeConversationId.value);
            
            // 角色数据
            const roles = ref([]);
            const roleTypes = ref([
                { value: 'scientist', label: '科学家' },
                { value: 'philosopher', label: '哲学家' },
                { value: 'fictional', label: '虚构人物' },
                { value: 'artist', label: '艺术家' },
                { value: 'historical', label: '历史人物' }
            ]);
            
            // 添加角色相关状态
            const showAddRoleForm = ref(false);
            const newRole = ref({
                name: '',
                description: '',
                promptTemplate: '',
                avatar: '', // 不可修改，由后端生成
                type: '',
                skills: ''
            });
            const isAddingRole = ref(false);
            
            // 内部状态
            let controller = null;
            let typingInterval = null;
            
            // 计算属性：过滤后的角色列表
            const filteredRoles = computed(() => {
                let result = [...roles.value];
                
                // 按关键词过滤
                if (roleSearchKeyword.value.trim()) {
                    const keyword = roleSearchKeyword.value.toLowerCase();
                    result = result.filter(role => 
                        role.name.toLowerCase().includes(keyword) ||
                        role.description.toLowerCase().includes(keyword) ||
                        role.skills.toLowerCase().includes(keyword)
                    );
                }
                
                // 按类型过滤
                if (selectedType.value) {
                    result = result.filter(role => role.type === selectedType.value);
                }
                
                return result;
            });
            
            // 初始化
            onMounted(async () => {
                // 检查暗黑模式偏好
                darkMode.value = localStorage.getItem('darkMode') === 'true' ||
                    (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                // 初始化语音录制 - 不需要在这里初始化，在toggleVoiceInput中处理
                
                // 加载角色列表
                await loadRoles();
                
                // 添加欢迎消息
                if (roles.value.length > 0) {
                    // 默认选择第一个角色
                    currentRole.value = roles.value[0];
                }
                
                // 聚焦输入框
                nextTick(() => {
                    if (textarea.value) {
                        textarea.value.focus();
                    }
                });
            });
            
            // 加载角色列表
            const loadRoles = async () => {
                try {
                    isLoadingRoles.value = true;
                    const response = await fetch('/roles');
                    const data = await response.json();
                    roles.value = data;
                    
                    // 如果没有角色数据，初始化角色
                    if (roles.value.length === 0) {
                        await fetch('/roles/init', { method: 'POST' });
                        // 重新加载角色
                        const initResponse = await fetch('/roles');
                        const initData = await initResponse.json();
                        roles.value = initData;
                    }
                } catch (error) {
                    console.error('加载角色列表失败:', error);
                    // 显示模拟角色数据
                    roles.value = [
                        {
                            id: 'einstein',
                            name: '爱因斯坦',
                            description: '著名物理学家，相对论的创立者，拥有丰富的科学知识。',
                            avatar: 'https://picsum.photos/seed/einstein/100/100',
                            type: 'scientist',
                            skills: '科学知识讲解，相对论解释，物理概念普及，科学思维训练'
                        },
                        {
                            id: 'harry-potter',
                            name: '哈利·波特',
                            description: '《哈利波特》系列小说的主角，霍格沃茨魔法学校的学生，擅长魁地奇和黑魔法防御术。',
                            avatar: 'https://picsum.photos/seed/harry/100/100',
                            type: 'fictional',
                            skills: '魔法知识讲解，冒险故事分享，魁地奇介绍，黑魔法防御术指导'
                        },
                        {
                            id: 'socrates',
                            name: '苏格拉底',
                            description: '古希腊著名哲学家，西方哲学的奠基人之一，以对话法和苏格拉底式提问闻名。',
                            avatar: 'https://picsum.photos/seed/socrates/100/100',
                            type: 'philosopher',
                            skills: '哲学思考引导，苏格拉底式提问，伦理道德探讨，逻辑思维训练'
                        }
                    ];
                } finally {
                    isLoadingRoles.value = false;
                }
            };
            
            // 重置添加角色表单
            const resetAddRoleForm = () => {
                newRole.value = {
                    name: '',
                    description: '',
                    promptTemplate: '',
                    avatar: '',
                    type: '',
                    skills: ''
                };
            };
            
            // 处理添加角色
            const handleAddRole = async () => {
                if (!newRole.value.name.trim() || 
                    !newRole.value.description.trim() || 
                    !newRole.value.promptTemplate.trim() || 
                    !newRole.value.type || 
                    !newRole.value.skills.trim()) {
                    alert('请填写所有必填字段');
                    return;
                }
                
                try {
                    isAddingRole.value = true;
                    
                    // 发送请求到后端创建角色
                    const response = await fetch('/roles/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newRole.value)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const createdRole = await response.json();
                    
                    // 将新角色添加到角色列表
                    roles.value.push(createdRole);
                    
                    // 关闭表单并重置
                    showAddRoleForm.value = false;
                    resetAddRoleForm();
                    
                    // 清空搜索和筛选条件
                    roleSearchKeyword.value = '';
                    selectedType.value = '';
                    
                    // 提示成功
                    alert('角色添加成功！');
                } catch (error) {
                    console.error('添加角色失败:', error);
                    alert('添加角色失败: ' + error.message);
                } finally {
                    isAddingRole.value = false;
                }
            };
            
            // 搜索角色
            const searchRoles = async () => {
                // 实时搜索逻辑已经在computed属性中实现
            };
            
            // 按类型过滤角色
            const filterRolesByType = (type) => {
                if (selectedType.value === type) {
                    selectedType.value = ''; // 取消选择
                } else {
                    selectedType.value = type;
                }
            };
            
            // 选择角色
            const selectRole = (role) => {
                currentRole.value = role;
                showRoleSelection.value = false;
                
                // 添加角色选择消息
                messages.value.push({
                    role: 'assistant',
                    content: `你好！我是${role.name}，${role.description}请问有什么可以帮助你的？`,
                    isLoading: false,
                    visibleChars: 0,
                    isStreaming: false
                });
                
                // 确保消息完全可见
                nextTick(() => {
                    if (messages.value.length > 0) {
                        messages.value[messages.value.length - 1].visibleChars = messages.value[messages.value.length - 1].content.length;
                    }
                    scrollToBottom();
                });
            };
            
            // 获取角色类型标签
            const getRoleTypeLabel = (type) => {
                const roleType = roleTypes.value.find(t => t.value === type);
                return roleType ? roleType.label : type;
            };
            
            // 调整文本区域高度
            const adjustTextareaHeight = () => {
                if (textarea.value) {
                    textarea.value.style.height = 'auto';
                    textarea.value.style.height = `${Math.min(textarea.value.scrollHeight, 200)}px`;
                }
            };
            
            // 滚动到底部
            const scrollToBottom = () => {
                nextTick(() => {
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                });
            };
            
            // 切换暗黑模式
            const toggleDarkMode = () => {
                darkMode.value = !darkMode.value;
                localStorage.setItem('darkMode', darkMode.value);
                document.body.classList.toggle('dark', darkMode.value);
            };
            
            // 新建会话
            const startNewConversation = () => {
                // 保存当前会话
                if (messages.value.length > 0) {
                    const lastMessage = messages.value[messages.value.length - 1];
                    conversations.value.push({
                        id: activeConversationId.value,
                        title: messages.value[0].content.substring(0, 20) + (messages.value[0].content.length > 20 ? '...' : ''),
                        lastMessage: lastMessage.content.substring(0, 50) + (lastMessage.content.length > 50 ? '...' : ''),
                        timestamp: new Date().toISOString()
                    });
                }
                
                // 清空聊天记录
                messages.value = [];
                // 生成新的会话ID
                activeConversationId.value = Date.now().toString();
                memoeryId.value = activeConversationId.value;
                
                // 滚动到底部
                scrollToBottom();
                // 聚焦输入框
                nextTick(() => {
                    if (textarea.value) {
                        textarea.value.focus();
                    }
                });
            };
            
            // 切换会话
            const switchConversation = (conversation) => {
                // 这里简化处理，实际应该从服务器加载会话历史
                activeConversationId.value = conversation.id;
                memoeryId.value = conversation.id;
                // 模拟加载会话历史
                messages.value = [
                    {
                        role: 'assistant',
                        content: conversation.title,
                        isLoading: false,
                        visibleChars: conversation.title.length,
                        isStreaming: false
                    }
                ];
                scrollToBottom();
            };
            
            // 模拟逐字打印效果
            const startTypingEffect = (messageIndex) => {
                const message = messages.value[messageIndex];
                if (!message || message.visibleChars >= message.content.length) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    messages.value[messageIndex].isStreaming = false;
                    return;
                }

                messages.value[messageIndex].visibleChars++;
                scrollToBottom();
            };
            
            // 发送消息
            const sendMessage = async () => {
                if (!userInput.value.trim() || isLoading.value || !currentRole.value) {
                    return;
                }

                // 中止之前的请求
                if (controller) {
                    controller.abort();
                }
                controller = new AbortController();

                const userMessage = {
                    role: 'user',
                    content: userInput.value.trim(),
                    isLoading: false,
                    visibleChars: userInput.value.trim().length,
                    isStreaming: false
                };

                messages.value.push(userMessage);

                const assistantMessage = {
                    role: 'assistant',
                    content: '',
                    isLoading: true,
                    visibleChars: 0,
                    isStreaming: true
                };

                messages.value.push(assistantMessage);

                userInput.value = '';
                voiceInputText.value = '';
                adjustTextareaHeight();
                scrollToBottom();

                isLoading.value = true;

                try {
                    // 构建请求URL，包含角色ID
                    const url = `/chat?message=${encodeURIComponent(userMessage.content)}&memoryId=${memoeryId.value}&roleId=${currentRole.value.id}`;
                    const response = await fetch(url, {
                        signal: controller.signal
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    let messageIndex = messages.value.length - 1;

                    // 先清除之前的打字效果
                    if (typingInterval) {
                        clearInterval(typingInterval);
                        typingInterval = null;
                    }

                    // 读取完整响应
                    const text = await response.text();
                    
                    // 去除可能存在的"data:"前缀
                    let cleanText = text;
                    if (cleanText.startsWith('data:')) {
                        cleanText = cleanText.substring(5);
                    }
                    
                    // 也处理多行情况，每行都可能有"data:"前缀
                    const lines = cleanText.split('\n');
                    const cleanLines = lines.map(line => {
                        if (line.startsWith('data:')) {
                            return line.substring(5);
                        }
                        return line;
                    });
                    cleanText = cleanLines.join('\n');

                    // 更新消息内容
                    messages.value[messageIndex].content = cleanText;
                    messages.value[messageIndex].isLoading = false;

                    // 启动打字效果
                    if (!typingInterval) {
                        typingInterval = setInterval(() => {
                            startTypingEffect(messageIndex);
                        }, 30); // 打字速度
                    }

                    scrollToBottom();

                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('请求被用户中止');
                    } else {
                        console.error('请求出错:', error);
                        const lastMessage = messages.value[messages.value.length - 1];
                        lastMessage.content = '抱歉，请求过程中出现错误: ' + error.message;
                        lastMessage.visibleChars = lastMessage.content.length;
                    }
                } finally {
                    const lastMessage = messages.value[messages.value.length - 1];
                    lastMessage.isLoading = false;
                    lastMessage.isStreaming = false;

                    // 确保所有字符都可见
                    if (lastMessage.visibleChars < lastMessage.content.length) {
                        lastMessage.visibleChars = lastMessage.content.length;
                    }

                    isLoading.value = false;
                    controller = null;

                    if (typingInterval) {
                        clearInterval(typingInterval);
                        typingInterval = null;
                    }

                    scrollToBottom();
                }
            };
            
            // 停止响应
            const stopResponse = () => {
                if (controller) {
                    controller.abort();
                    const lastMessage = messages.value[messages.value.length - 1];
                    lastMessage.isLoading = false;
                    lastMessage.isStreaming = false;

                    if (lastMessage.visibleChars < lastMessage.content.length) {
                        lastMessage.visibleChars = lastMessage.content.length;
                    }

                    isLoading.value = false;
                    controller = null;

                    if (typingInterval) {
                        clearInterval(typingInterval);
                        typingInterval = null;
                    }
                }
            };
            
            // 切换语音输入
            const toggleVoiceInput = async () => {
                if (!hasSpeechRecognition.value) {
                    voiceInputText.value = '您的浏览器不支持语音录制功能';
                    setTimeout(() => {
                        voiceInputText.value = '';
                    }, 3000);
                    return;
                }
                
                if (isVoiceRecording.value) {
                    // 停止录音
                    stopVoiceRecording();
                } else {
                    // 开始录音
                    await startVoiceRecording();
                }
            };
            
            // 开始语音录制
            const startVoiceRecording = async () => {
                try {
                    // 获取用户媒体权限
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // 创建MediaRecorder实例
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                    
                    // 重置音频块数组
                    audioChunks = [];
                    
                    // 监听音频数据可用事件
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    // 监听录音停止事件
                    mediaRecorder.onstop = async () => {
                        try {
                            // 创建Blob对象
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            
                            // 创建FormData
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'recording.webm');
                            formData.append('format', 'webm');
                            
                            // 显示正在识别的提示
                            voiceInputText.value = '正在识别...';
                            
                            // 发送到后端进行语音识别
                            const response = await fetch('/speech/to-text', {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (response.ok) {
                                // 获取识别结果
                                const text = await response.text();
                                voiceInputText.value = text;
                                userInput.value = text;
                                adjustTextareaHeight();
                            } else {
                                throw new Error('识别失败');
                            }
                        } catch (error) {
                            console.error('语音识别错误:', error);
                            voiceInputText.value = '语音识别失败: ' + error.message;
                            setTimeout(() => {
                                voiceInputText.value = '';
                            }, 3000);
                        } finally {
                            // 释放媒体流
                            if (stream) {
                                stream.getTracks().forEach(track => track.stop());
                                stream = null;
                            }
                            
                            // 重置状态
                            audioChunks = [];
                            isVoiceRecording.value = false;
                        }
                    };
                    
                    // 开始录音
                    mediaRecorder.start();
                    isVoiceRecording.value = true;
                    voiceInputText.value = '';
                } catch (error) {
                    console.error('开始录音失败:', error);
                    voiceInputText.value = '无法访问麦克风，请检查权限设置';
                    setTimeout(() => {
                        voiceInputText.value = '';
                    }, 3000);
                }
            };
            
            // 停止语音录制
            const stopVoiceRecording = () => {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                isVoiceRecording.value = false;
            };
            
            // 播放语音响应
            const playVoiceResponse = () => {
                if (!hasSpeechSynthesis.value || messages.value.length === 0) {
                    return;
                }
                
                const lastMessage = messages.value[messages.value.length - 1];
                if (lastMessage.role !== 'assistant') {
                    return;
                }
                
                // 停止任何正在播放的语音
                window.speechSynthesis.cancel();
                
                // 创建语音合成实例
                const utterance = new SpeechSynthesisUtterance(lastMessage.content);
                utterance.lang = 'zh-CN';
                
                // 根据角色选择不同的语音特征
                if (currentRole.value) {
                    if (currentRole.value.id === 'einstein' || currentRole.value.id === 'socrates') {
                        // 为男性角色选择较低的音调
                        utterance.pitch = 0.8;
                        utterance.rate = 0.9;
                    } else {
                        // 默认设置
                        utterance.pitch = 1.0;
                        utterance.rate = 1.0;
                    }
                }
                
                // 播放语音
                window.speechSynthesis.speak(utterance);
            };
            
            // 监听消息变化自动滚动
            watch(messages, scrollToBottom, {deep: true});

            return {
                // 状态
                messages,
                userInput,
                isLoading,
                darkMode,
                chatContainer,
                textarea,
                showRoleSelection,
                currentRole,
                roleSearchKeyword,
                selectedType,
                isLoadingRoles,
                roles,
                roleTypes,
                filteredRoles,
                conversations,
                activeConversationId,
                isVoiceRecording,
                voiceInputText,
                hasSpeechRecognition,
                hasSpeechSynthesis,
                showAddRoleForm,
                newRole,
                isAddingRole,
                
                // 方法
                sendMessage,
                stopResponse,
                toggleDarkMode,
                adjustTextareaHeight,
                startNewConversation,
                loadRoles,
                searchRoles,
                filterRolesByType,
                selectRole,
                getRoleTypeLabel,
                switchConversation,
                toggleVoiceInput,
                playVoiceResponse,
                resetAddRoleForm,
                handleAddRole
            };
        }
    }).mount('#app');
</script>
</body>
</html>